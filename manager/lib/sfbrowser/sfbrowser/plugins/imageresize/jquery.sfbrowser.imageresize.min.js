(function(B){var x;var n;var J;var t;var g;var j;var w;var k;var f;var F;var L;var P;var q;var y;var C;var r;var O;var H;var Q;var a;var G;var o;var M;var K;var u;var s=-1;var D;var N;var p;var z;var e;var m;var d;var c;var I;var v;var b;var R;B.fn.extend(B.sfbrowser,{imageresize:function(T){x=T.trace;n=T.openDir;f=T.aPath;L=T.oTree;F=T.oSettings;J=T.addContextItem;t=T.file;g=T.lang;j=T.gettext;w=T.moveWindowDown;k=T.resizeWindow;P=T.$Document;q=T.$Window;y=T.$Body;C=T.$SFB;r=T.$SFBWin;O=T.$TableH;H=T.$Table;Q=T.$TbBody;a=T.$TrLoading;G=T.$Context;var S=B.sfbrowser;o=F.sfbpath+"plugins/imageresize/connectors/"+F.connector+"/imageresize."+F.connector;B(F.imageresize).prependTo(C.find("#fbwin")).hide();C.find("#sfbimgresize>div.sfbheader>h3").mousedown(w);C.find("div.cancelresize").text(j("cancel")).click(function(){B("#sfbimgresize").hide();B("#winbrowser").show();k()});C.find("div.resize").text(j("resize")).click(E);C.find("div.handle").attr("title",j("dragMe")).mousedown(i);C.find("div#crop").attr("title",j("dragMe")).mousedown(i);B("div#sfbimgresize>div.fbcontent>label[for=rszperc]").text(j("scale"));B("form#sfbsize legend:eq(0)").text(j("resize")+":");B("form#sfbsize label[for=rszW]").text(j("width"));B("form#sfbsize label[for=rszH]").text(j("height"));B("form#sfbsize input[name=rszW]").change(function(){p=Math.min(M.width,parseInt(B(this).val()));z=p/D;A()});B("form#sfbsize input[name=rszH]").change(function(){z=Math.min(M.height,parseInt(B(this).val()));p=z*D;A()});B("form#sfbsize legend:eq(1)").text(j("crop")+":");B("form#sfbsize label[for=crpW]").text(j("width"));B("form#sfbsize label[for=crpH]").text(j("height"));B("form#sfbsize input[name=crpX]").change(function(){d=parseInt(B(this).val());A()});B("form#sfbsize input[name=crpY]").change(function(){c=parseInt(B(this).val());A()});B("form#sfbsize input[name=crpW]").change(function(){e=parseInt(B(this).val());A()});B("form#sfbsize input[name=crpH]").change(function(){m=parseInt(B(this).val());A()});K=J("resize",j("resize"),function(){l()},0)}});B.extend(B.sfbrowser.imageresize,{resizeWindow:function(U,T){if(M){var V=B("#fbwin").width()-B("form#sfbsize").width()-20;var S=B("#fbwin").height()-70;N=Math.min(1,Math.min(V/M.width,S/M.height));B("div#sfbimgresize>div.fbcontent>span#rszperc").text(Math.round(N*100)+"%");B("#sfbimgresize div#org").css({width:(N*M.width)+"px",height:(N*M.height)+"px"});A()}},checkContextItem:function(T,S){K.css({display:T.width!==undefined&&T.height!==undefined?"block":"none"})}});function l(S){B("#winbrowser").hide();B("#sfbimgresize").show();M=t();D=M.width/M.height;b=e=p=M.width;R=m=z=M.height;I=v=d=c=0;B("#sfbimgresize>div.sfbheader>h3").text(j("imgResize")+": "+M.file);B("div#sfbrsimg>img").attr("src",F.sfbpath+f.join("")+M.file+"?"+Math.random());B.sfbrowser.imageresize.resizeWindow()}function i(S){I=d;v=c;b=e;R=m;var T=this;C.find("div.handle").each(function(U){if(B(this)[0]==T){s=U}});u=B(this);if(u[0]==B("div#crop")[0]){s=10}B("body").mousemove(h).mouseup(function(){B("body").unbind("mousemove",h);s=-1;u=null});S.stopPropagation();return false}function h(U){var W=u.parent();var S=Math.min(Math.max(0,Math.round((U.pageX-W.offset().left)/N)),M.width);var V=Math.min(Math.max(0,Math.round((U.pageY-W.offset().top)/N)),M.height);switch(s){case 10:d=S-e/2;c=V-m/2;break;case 8:p=S;z=V;break;default:for(var T=0;T<(s<4?2:1);T++){switch(((s%4)-T+4)%4){case 0:c=V;m=R-(c-v);break;case 1:e=S-d;break;case 2:m=V-c;break;case 3:d=S;e=b-(d-I);break}}}A();U.stopPropagation();return false}function A(){p=Math.max(1,p);z=Math.max(1,z);if(p/z>D){z=p/D}else{p=z*D}d=Math.max(Math.min(d,p-e),0);c=Math.max(Math.min(c,z-m),0);e=Math.max(1,Math.min(e,p-d));m=Math.max(1,Math.min(m,z-c));var W=p*N;var U=z*N;var Y=d*N;var X=c*N;var S=e*N;var V=m*N;B("div#sfbrsimg>img").css({width:W+"px",height:U+"px"});B("#sfbimgresize div#crop").css({left:Y+"px",top:X+"px",width:S+"px",height:V+"px"});B("div.handle:eq(8)").css({left:(W-6)+"px",top:(U-6)+"px"});B("div.handle:eq(0)").css({left:(Y-6)+"px",top:(X-6)+"px"});B("div.handle:eq(1)").css({left:(Y+S-6)+"px",top:(X-6)+"px"});B("div.handle:eq(2)").css({left:(Y+S-6)+"px",top:(X+V-6)+"px"});B("div.handle:eq(3)").css({left:(Y-6)+"px",top:(X+V-6)+"px"});B("div.handle:eq(4)").css({left:(Y+S/2-6)+"px",top:(X-6)+"px"});B("div.handle:eq(5)").css({left:(Y+S-6)+"px",top:(X+V/2-6)+"px"});B("div.handle:eq(6)").css({left:(Y+S/2-6)+"px",top:(X+V-6)+"px"});B("div.handle:eq(7)").css({left:(Y-6)+"px",top:(X+V/2-6)+"px"});var T=p/M.width;B("form#sfbsize input[name=rszW]").val(Math.round(p));B("form#sfbsize input[name=rszH]").val(Math.round(z));B("form#sfbsize input[name=crpX]").val(Math.round(d));B("form#sfbsize input[name=crpY]").val(Math.round(c));B("form#sfbsize input[name=crpW]").val(Math.round(e));B("form#sfbsize input[name=crpH]").val(Math.round(m))}function E(){x("sfb resizeSend");var T=B("form#sfbsize input[name=rszW]").val();var V=B("form#sfbsize input[name=rszH]").val();var X=B("form#sfbsize input[name=crpX]").val();var W=B("form#sfbsize input[name=crpY]").val();var S=B("form#sfbsize input[name=crpW]").val();var U=B("form#sfbsize input[name=crpH]").val();if(T==M.width&&V==M.height&&S==M.width&&U==M.height){x("sfb Will not resize to same size.")}else{x("sfb Sending resize request...");B.ajax({type:"POST",url:o,data:"a=bar&folder="+f.join("")+"&file="+M.file+"&w="+T+"&h="+V+"&cx="+X+"&cy="+W+"&cw="+S+"&ch="+U,dataType:"json",success:function(aa,Z){if(typeof(aa.error)!="undefined"){if(aa.error!=""){x(g(aa.error));alert(g(aa.error))}else{M.width=S;M.height=U;M.tr.find("td:eq(4)").attr("abbr",S*U).text(S+" x "+U+" px");var Y=B("#fbpreview").clone(true);B("#fbpreview").html("");B("#fbpreview").html(Y.children());B("#sfbimgresize").hide();B("#winbrowser").show();k()}}}})}}})(jQuery);